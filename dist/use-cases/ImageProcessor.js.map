{"version":3,"file":"ImageProcessor.js","sources":["../../src/use-cases/ImageProcessor.ts"],"sourcesContent":["/**\n * Image Processor Use Case\n * Orchestrates image rendering and export with CRT subpixel effect\n */\nimport type { ExportOptions } from \"../core/types.js\";\nimport type {\n  IGpuContext,\n  IRenderPipeline,\n  ICanvasManager,\n  ISettingsManager,\n} from \"../core/ports/index.js\";\nimport { Dimensions, PixelDensity } from \"../core/value-objects/index.js\";\nimport { SubpixelRenderer } from \"../core/services/index.js\";\n\n/**\n * Handles image processing operations\n */\nexport class ImageProcessor {\n  private readonly subpixelRenderer: SubpixelRenderer;\n\n  constructor(\n    private gpuContext: IGpuContext,\n    private pipeline: IRenderPipeline,\n    private canvasManager: ICanvasManager,\n    private settingsManager: ISettingsManager,\n  ) {\n    this.subpixelRenderer = new SubpixelRenderer();\n  }\n\n  /**\n   * Render an image with CRT subpixel effect to the canvas\n   * @param canvas Target canvas element\n   * @param input ImageBitmap to process\n   */\n  async render(canvas: HTMLCanvasElement, input: ImageBitmap): Promise<void> {\n    if (!this.gpuContext.initialized || !this.pipeline.isCreated) {\n      throw new Error(\"Processor not initialized\");\n    }\n\n    // Configure canvas\n    this.canvasManager.configure(canvas, this.gpuContext);\n\n    // Create domain objects\n    const inputDimensions = new Dimensions(input.width, input.height);\n    const pixelDensity = PixelDensity.from(this.settingsManager.pixelDensity);\n\n    // Set canvas size (3x input for full detail)\n    this.canvasManager.setSize(inputDimensions);\n\n    // Update input dimensions\n    this.gpuContext.writeInputDimensions(inputDimensions);\n\n    // Calculate and update output dimensions using domain service\n    const outputDimensions = this.subpixelRenderer.calculateOutputDimensions(\n      inputDimensions,\n      pixelDensity,\n    );\n    this.gpuContext.writeOutputDimensions(outputDimensions);\n\n    // Convert ImageBitmap to VideoFrame for external texture\n    const videoFrame = new VideoFrame(input, { timestamp: 0 });\n\n    try {\n      // Render\n      this.pipeline.render(\n        videoFrame,\n        this.canvasManager.getCurrentTextureView(),\n      );\n\n      // Wait for GPU to finish\n      await this.gpuContext.flush();\n\n      // Update aspect ratio\n      this.canvasManager.setAspectRatio(inputDimensions);\n\n      const canvasSize = this.canvasManager.currentCanvas;\n      console.log(\n        `Image rendered: ${canvasSize?.width}x${canvasSize?.height}, logical pixels ${outputDimensions.width}x${outputDimensions.height}`,\n      );\n    } finally {\n      // Clean up VideoFrame\n      videoFrame.close();\n    }\n  }\n\n  /**\n   * Export an image with CRT effect as a Blob\n   * Re-renders the image to capture the result (WebGPU clears after present)\n   * @param input ImageBitmap to process and export\n   * @param options Export options (type, quality)\n   */\n  async export(\n    input: ImageBitmap,\n    options: ExportOptions = {},\n  ): Promise<Blob | null> {\n    if (\n      !this.gpuContext.initialized ||\n      !this.pipeline.isCreated ||\n      !this.canvasManager.isConfigured\n    ) {\n      console.warn(\n        \"Cannot export: processor not ready or no canvas configured\",\n      );\n      return null;\n    }\n\n    const type = options.type ?? \"image/png\";\n    const quality = options.quality;\n\n    // Create domain objects\n    const inputDimensions = new Dimensions(input.width, input.height);\n    const pixelDensity = PixelDensity.from(this.settingsManager.pixelDensity);\n\n    // Update dimensions\n    this.gpuContext.writeInputDimensions(inputDimensions);\n\n    // Calculate output dimensions using domain service\n    const outputDimensions = this.subpixelRenderer.calculateOutputDimensions(\n      inputDimensions,\n      pixelDensity,\n    );\n    this.gpuContext.writeOutputDimensions(outputDimensions);\n\n    // Convert to VideoFrame\n    const videoFrame = new VideoFrame(input, { timestamp: 0 });\n\n    try {\n      // Render\n      this.pipeline.render(\n        videoFrame,\n        this.canvasManager.getCurrentTextureView(),\n      );\n\n      // CRITICAL: Call toBlob synchronously right after draw\n      // This ensures canvas content is captured before frame is presented\n      const blobPromise = this.canvasManager.toBlobSync(type, quality);\n\n      // Wait for GPU completion\n      await this.gpuContext.flush();\n\n      return blobPromise;\n    } finally {\n      videoFrame.close();\n    }\n  }\n}\n"],"names":["ImageProcessor","gpuContext","pipeline","canvasManager","settingsManager","SubpixelRenderer","canvas","input","inputDimensions","Dimensions","pixelDensity","PixelDensity","outputDimensions","videoFrame","canvasSize","options","type","quality","blobPromise"],"mappings":";;;AAiBO,MAAMA,EAAe;AAAA,EAG1B,YACUC,GACAC,GACAC,GACAC,GACR;AAJQ,SAAA,aAAAH,GACA,KAAA,WAAAC,GACA,KAAA,gBAAAC,GACA,KAAA,kBAAAC,GAER,KAAK,mBAAmB,IAAIC,EAAA;AAAA,EAC9B;AAAA,EATiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAgBjB,MAAM,OAAOC,GAA2BC,GAAmC;AACzE,QAAI,CAAC,KAAK,WAAW,eAAe,CAAC,KAAK,SAAS;AACjD,YAAM,IAAI,MAAM,2BAA2B;AAI7C,SAAK,cAAc,UAAUD,GAAQ,KAAK,UAAU;AAGpD,UAAME,IAAkB,IAAIC,EAAWF,EAAM,OAAOA,EAAM,MAAM,GAC1DG,IAAeC,EAAa,KAAK,KAAK,gBAAgB,YAAY;AAGxE,SAAK,cAAc,QAAQH,CAAe,GAG1C,KAAK,WAAW,qBAAqBA,CAAe;AAGpD,UAAMI,IAAmB,KAAK,iBAAiB;AAAA,MAC7CJ;AAAA,MACAE;AAAA,IAAA;AAEF,SAAK,WAAW,sBAAsBE,CAAgB;AAGtD,UAAMC,IAAa,IAAI,WAAWN,GAAO,EAAE,WAAW,GAAG;AAEzD,QAAI;AAEF,WAAK,SAAS;AAAA,QACZM;AAAA,QACA,KAAK,cAAc,sBAAA;AAAA,MAAsB,GAI3C,MAAM,KAAK,WAAW,MAAA,GAGtB,KAAK,cAAc,eAAeL,CAAe;AAEjD,YAAMM,IAAa,KAAK,cAAc;AACtC,cAAQ;AAAA,QACN,mBAAmBA,GAAY,KAAK,IAAIA,GAAY,MAAM,oBAAoBF,EAAiB,KAAK,IAAIA,EAAiB,MAAM;AAAA,MAAA;AAAA,IAEnI,UAAA;AAEE,MAAAC,EAAW,MAAA;AAAA,IACb;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,OACJN,GACAQ,IAAyB,IACH;AACtB,QACE,CAAC,KAAK,WAAW,eACjB,CAAC,KAAK,SAAS,aACf,CAAC,KAAK,cAAc;AAEpB,qBAAQ;AAAA,QACN;AAAA,MAAA,GAEK;AAGT,UAAMC,IAAOD,EAAQ,QAAQ,aACvBE,IAAUF,EAAQ,SAGlBP,IAAkB,IAAIC,EAAWF,EAAM,OAAOA,EAAM,MAAM,GAC1DG,IAAeC,EAAa,KAAK,KAAK,gBAAgB,YAAY;AAGxE,SAAK,WAAW,qBAAqBH,CAAe;AAGpD,UAAMI,IAAmB,KAAK,iBAAiB;AAAA,MAC7CJ;AAAA,MACAE;AAAA,IAAA;AAEF,SAAK,WAAW,sBAAsBE,CAAgB;AAGtD,UAAMC,IAAa,IAAI,WAAWN,GAAO,EAAE,WAAW,GAAG;AAEzD,QAAI;AAEF,WAAK,SAAS;AAAA,QACZM;AAAA,QACA,KAAK,cAAc,sBAAA;AAAA,MAAsB;AAK3C,YAAMK,IAAc,KAAK,cAAc,WAAWF,GAAMC,CAAO;AAG/D,mBAAM,KAAK,WAAW,MAAA,GAEfC;AAAA,IACT,UAAA;AACE,MAAAL,EAAW,MAAA;AAAA,IACb;AAAA,EACF;AACF;"}