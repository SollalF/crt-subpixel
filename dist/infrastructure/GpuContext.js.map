{"version":3,"file":"GpuContext.js","sources":["../../src/infrastructure/GpuContext.ts"],"sourcesContent":["/**\n * GPU Context Management\n * Handles WebGPU device initialization, uniform buffers, and sampler creation\n */\nimport tgpu, { type TgpuRoot, type TgpuUniform } from \"typegpu\";\nimport * as d from \"typegpu/data\";\n\nimport { Dimensions } from \"../core/value-objects/Dimensions.js\";\nimport type { IGpuContext } from \"../core/ports/IGpuContext.js\";\n\n/**\n * Manages WebGPU resources including device, buffers, and samplers\n */\nexport class GpuContext implements IGpuContext {\n  private root: TgpuRoot | null = null;\n  private _sampler: ReturnType<TgpuRoot[\"~unstable\"][\"createSampler\"]> | null =\n    null;\n  private _outputDimensionsBuffer: TgpuUniform<d.Vec2u> | null = null;\n  private _inputDimensionsBuffer: TgpuUniform<d.Vec2u> | null = null;\n  private _orientationBuffer: TgpuUniform<d.U32> | null = null;\n  private _pixelDensityBuffer: TgpuUniform<d.U32> | null = null;\n  private _interlacedBuffer: TgpuUniform<d.U32> | null = null;\n  private _fieldBuffer: TgpuUniform<d.U32> | null = null;\n  private _presentationFormat: GPUTextureFormat | null = null;\n  private _initialized = false;\n\n  /**\n   * Check if GPU context is initialized\n   */\n  get initialized(): boolean {\n    return this._initialized;\n  }\n\n  /**\n   * Get the TypeGPU root (throws if not initialized)\n   */\n  get tgpuRoot(): TgpuRoot {\n    if (!this.root) {\n      throw new Error(\"GpuContext not initialized\");\n    }\n    return this.root;\n  }\n\n  /**\n   * Get the GPU device (throws if not initialized)\n   */\n  get device(): GPUDevice {\n    return this.tgpuRoot.device;\n  }\n\n  /**\n   * Get the texture sampler (throws if not initialized)\n   */\n  get sampler(): ReturnType<TgpuRoot[\"~unstable\"][\"createSampler\"]> {\n    if (!this._sampler) {\n      throw new Error(\"GpuContext not initialized\");\n    }\n    return this._sampler;\n  }\n\n  /**\n   * Get the presentation format (throws if not initialized)\n   */\n  get presentationFormat(): GPUTextureFormat {\n    if (!this._presentationFormat) {\n      throw new Error(\"GpuContext not initialized\");\n    }\n    return this._presentationFormat;\n  }\n\n  /**\n   * Get the output dimensions buffer (throws if not initialized)\n   */\n  get outputDimensionsBuffer(): TgpuUniform<d.Vec2u> {\n    if (!this._outputDimensionsBuffer) {\n      throw new Error(\"GpuContext not initialized\");\n    }\n    return this._outputDimensionsBuffer;\n  }\n\n  /**\n   * Get the input dimensions buffer (throws if not initialized)\n   */\n  get inputDimensionsBuffer(): TgpuUniform<d.Vec2u> {\n    if (!this._inputDimensionsBuffer) {\n      throw new Error(\"GpuContext not initialized\");\n    }\n    return this._inputDimensionsBuffer;\n  }\n\n  /**\n   * Get the orientation buffer (throws if not initialized)\n   */\n  get orientationBuffer(): TgpuUniform<d.U32> {\n    if (!this._orientationBuffer) {\n      throw new Error(\"GpuContext not initialized\");\n    }\n    return this._orientationBuffer;\n  }\n\n  /**\n   * Get the pixel density buffer (throws if not initialized)\n   */\n  get pixelDensityBuffer(): TgpuUniform<d.U32> {\n    if (!this._pixelDensityBuffer) {\n      throw new Error(\"GpuContext not initialized\");\n    }\n    return this._pixelDensityBuffer;\n  }\n\n  /**\n   * Get the interlaced buffer (throws if not initialized)\n   */\n  get interlacedBuffer(): TgpuUniform<d.U32> {\n    if (!this._interlacedBuffer) {\n      throw new Error(\"GpuContext not initialized\");\n    }\n    return this._interlacedBuffer;\n  }\n\n  /**\n   * Get the field buffer (throws if not initialized)\n   */\n  get fieldBuffer(): TgpuUniform<d.U32> {\n    if (!this._fieldBuffer) {\n      throw new Error(\"GpuContext not initialized\");\n    }\n    return this._fieldBuffer;\n  }\n\n  /**\n   * Initialize WebGPU device and create shared resources\n   */\n  async init(): Promise<void> {\n    if (this._initialized) {\n      console.log(\"GpuContext already initialized\");\n      return;\n    }\n\n    // TypeGPU handles WebGPU initialization and error checking\n    this.root = await tgpu.init();\n\n    // Handle device loss\n    this.root.device.lost.then((info) => {\n      console.error(`GPU device was lost: ${info.message}`);\n    });\n\n    console.log(\"GPU device initialized\");\n\n    // Create shared sampler for texture sampling\n    this._sampler = this.root[\"~unstable\"].createSampler({\n      magFilter: \"linear\",\n      minFilter: \"linear\",\n    });\n\n    // Create uniform buffers\n    this._outputDimensionsBuffer = this.root.createUniform(\n      d.vec2u,\n      d.vec2u(1, 1),\n    );\n\n    this._inputDimensionsBuffer = this.root.createUniform(\n      d.vec2u,\n      d.vec2u(1, 1),\n    );\n\n    this._orientationBuffer = this.root.createUniform(d.u32, 0);\n\n    this._pixelDensityBuffer = this.root.createUniform(d.u32, 1);\n\n    this._interlacedBuffer = this.root.createUniform(d.u32, 0);\n\n    this._fieldBuffer = this.root.createUniform(d.u32, 1);\n\n    // Get preferred canvas format\n    this._presentationFormat = navigator.gpu.getPreferredCanvasFormat();\n\n    this._initialized = true;\n  }\n\n  /**\n   * Update output dimensions uniform buffer\n   */\n  writeOutputDimensions(dimensions: Dimensions): void {\n    this.outputDimensionsBuffer.write(\n      d.vec2u(dimensions.width, dimensions.height),\n    );\n  }\n\n  /**\n   * Update input dimensions uniform buffer\n   */\n  writeInputDimensions(dimensions: Dimensions): void {\n    this.inputDimensionsBuffer.write(\n      d.vec2u(dimensions.width, dimensions.height),\n    );\n  }\n\n  /**\n   * Update orientation uniform buffer\n   * @param isRows true for horizontal stripes, false for vertical stripes\n   */\n  writeOrientation(isRows: boolean): void {\n    this.orientationBuffer.write(isRows ? 1 : 0);\n  }\n\n  /**\n   * Update pixel density uniform buffer\n   */\n  writePixelDensity(density: number): void {\n    this.pixelDensityBuffer.write(Math.max(1, Math.floor(density)));\n  }\n\n  /**\n   * Update interlaced uniform buffer\n   * @param enabled true for interlaced, false for progressive\n   */\n  writeInterlaced(enabled: boolean): void {\n    this.interlacedBuffer.write(enabled ? 1 : 0);\n  }\n\n  /**\n   * Update field uniform buffer\n   * @param isOdd true for odd field, false for even field\n   */\n  writeField(isOdd: boolean): void {\n    this.fieldBuffer.write(isOdd ? 1 : 0);\n  }\n\n  /**\n   * Create a bind group using the TypeGPU root\n   */\n  createBindGroup<T extends Parameters<TgpuRoot[\"createBindGroup\"]>[0]>(\n    layout: T,\n    entries: Parameters<TgpuRoot[\"createBindGroup\"]>[1],\n  ): ReturnType<TgpuRoot[\"createBindGroup\"]> {\n    return this.tgpuRoot.createBindGroup(layout, entries);\n  }\n\n  /**\n   * Wait for all submitted GPU work to complete\n   */\n  async flush(): Promise<void> {\n    await this.device.queue.onSubmittedWorkDone();\n  }\n\n  /**\n   * Clean up all GPU resources\n   */\n  destroy(): void {\n    if (this.root) {\n      this.root.destroy();\n      this.root = null;\n    }\n\n    this._sampler = null;\n    this._outputDimensionsBuffer = null;\n    this._inputDimensionsBuffer = null;\n    this._orientationBuffer = null;\n    this._pixelDensityBuffer = null;\n    this._interlacedBuffer = null;\n    this._fieldBuffer = null;\n    this._presentationFormat = null;\n    this._initialized = false;\n  }\n}\n"],"names":["GpuContext","tgpu","info","d","dimensions","isRows","density","enabled","isOdd","layout","entries"],"mappings":";;AAaO,MAAMA,EAAkC;AAAA,EACrC,OAAwB;AAAA,EACxB,WACN;AAAA,EACM,0BAAuD;AAAA,EACvD,yBAAsD;AAAA,EACtD,qBAAgD;AAAA,EAChD,sBAAiD;AAAA,EACjD,oBAA+C;AAAA,EAC/C,eAA0C;AAAA,EAC1C,sBAA+C;AAAA,EAC/C,eAAe;AAAA;AAAA;AAAA;AAAA,EAKvB,IAAI,cAAuB;AACzB,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,WAAqB;AACvB,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,MAAM,4BAA4B;AAE9C,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,SAAoB;AACtB,WAAO,KAAK,SAAS;AAAA,EACvB;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,UAA8D;AAChE,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,MAAM,4BAA4B;AAE9C,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,qBAAuC;AACzC,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,MAAM,4BAA4B;AAE9C,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,yBAA+C;AACjD,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,MAAM,4BAA4B;AAE9C,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,wBAA8C;AAChD,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,MAAM,4BAA4B;AAE9C,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,oBAAwC;AAC1C,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,MAAM,4BAA4B;AAE9C,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,qBAAyC;AAC3C,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,MAAM,4BAA4B;AAE9C,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,mBAAuC;AACzC,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,MAAM,4BAA4B;AAE9C,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,cAAkC;AACpC,QAAI,CAAC,KAAK;AACR,YAAM,IAAI,MAAM,4BAA4B;AAE9C,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,OAAsB;AAC1B,QAAI,KAAK,cAAc;AACrB,cAAQ,IAAI,gCAAgC;AAC5C;AAAA,IACF;AAGA,SAAK,OAAO,MAAMC,EAAK,KAAA,GAGvB,KAAK,KAAK,OAAO,KAAK,KAAK,CAACC,MAAS;AACnC,cAAQ,MAAM,wBAAwBA,EAAK,OAAO,EAAE;AAAA,IACtD,CAAC,GAED,QAAQ,IAAI,wBAAwB,GAGpC,KAAK,WAAW,KAAK,KAAK,WAAW,EAAE,cAAc;AAAA,MACnD,WAAW;AAAA,MACX,WAAW;AAAA,IAAA,CACZ,GAGD,KAAK,0BAA0B,KAAK,KAAK;AAAA,MACvCC,EAAE;AAAA,MACFA,EAAE,MAAM,GAAG,CAAC;AAAA,IAAA,GAGd,KAAK,yBAAyB,KAAK,KAAK;AAAA,MACtCA,EAAE;AAAA,MACFA,EAAE,MAAM,GAAG,CAAC;AAAA,IAAA,GAGd,KAAK,qBAAqB,KAAK,KAAK,cAAcA,EAAE,KAAK,CAAC,GAE1D,KAAK,sBAAsB,KAAK,KAAK,cAAcA,EAAE,KAAK,CAAC,GAE3D,KAAK,oBAAoB,KAAK,KAAK,cAAcA,EAAE,KAAK,CAAC,GAEzD,KAAK,eAAe,KAAK,KAAK,cAAcA,EAAE,KAAK,CAAC,GAGpD,KAAK,sBAAsB,UAAU,IAAI,yBAAA,GAEzC,KAAK,eAAe;AAAA,EACtB;AAAA;AAAA;AAAA;AAAA,EAKA,sBAAsBC,GAA8B;AAClD,SAAK,uBAAuB;AAAA,MAC1BD,EAAE,MAAMC,EAAW,OAAOA,EAAW,MAAM;AAAA,IAAA;AAAA,EAE/C;AAAA;AAAA;AAAA;AAAA,EAKA,qBAAqBA,GAA8B;AACjD,SAAK,sBAAsB;AAAA,MACzBD,EAAE,MAAMC,EAAW,OAAOA,EAAW,MAAM;AAAA,IAAA;AAAA,EAE/C;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,iBAAiBC,GAAuB;AACtC,SAAK,kBAAkB,MAAMA,IAAS,IAAI,CAAC;AAAA,EAC7C;AAAA;AAAA;AAAA;AAAA,EAKA,kBAAkBC,GAAuB;AACvC,SAAK,mBAAmB,MAAM,KAAK,IAAI,GAAG,KAAK,MAAMA,CAAO,CAAC,CAAC;AAAA,EAChE;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,gBAAgBC,GAAwB;AACtC,SAAK,iBAAiB,MAAMA,IAAU,IAAI,CAAC;AAAA,EAC7C;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,WAAWC,GAAsB;AAC/B,SAAK,YAAY,MAAMA,IAAQ,IAAI,CAAC;AAAA,EACtC;AAAA;AAAA;AAAA;AAAA,EAKA,gBACEC,GACAC,GACyC;AACzC,WAAO,KAAK,SAAS,gBAAgBD,GAAQC,CAAO;AAAA,EACtD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,QAAuB;AAC3B,UAAM,KAAK,OAAO,MAAM,oBAAA;AAAA,EAC1B;AAAA;AAAA;AAAA;AAAA,EAKA,UAAgB;AACd,IAAI,KAAK,SACP,KAAK,KAAK,QAAA,GACV,KAAK,OAAO,OAGd,KAAK,WAAW,MAChB,KAAK,0BAA0B,MAC/B,KAAK,yBAAyB,MAC9B,KAAK,qBAAqB,MAC1B,KAAK,sBAAsB,MAC3B,KAAK,oBAAoB,MACzB,KAAK,eAAe,MACpB,KAAK,sBAAsB,MAC3B,KAAK,eAAe;AAAA,EACtB;AACF;"}