{"version":3,"file":"SettingsManager.js","sources":["../../src/infrastructure/SettingsManager.ts"],"sourcesContent":["/**\n * Settings Manager\n * Manages runtime settings like orientation and pixel density\n */\nimport {\n  type ProcessorSettings,\n  type Orientation as OrientationType,\n  DEFAULT_SETTINGS,\n} from \"../core/types.js\";\nimport { Orientation } from \"../core/value-objects/Orientation.js\";\nimport type { ISettingsManager } from \"../core/ports/ISettingsManager.js\";\nimport type { IGpuContext } from \"../core/ports/IGpuContext.js\";\n\n/**\n * Settings input type that allows string orientation for backward compatibility\n */\ntype SettingsInput = Omit<Partial<ProcessorSettings>, \"orientation\"> & {\n  orientation?: Orientation | OrientationType;\n  field?: \"odd\" | \"even\";\n};\n\n/**\n * Manages processor settings and syncs them to GPU buffers\n */\nexport class SettingsManager implements ISettingsManager {\n  private settings: ProcessorSettings;\n  private gpuContext: IGpuContext | null = null;\n\n  constructor(initialSettings: SettingsInput = {}) {\n    this.settings = { ...DEFAULT_SETTINGS };\n    // Handle orientation conversion if provided\n    if (initialSettings.orientation !== undefined) {\n      this.settings.orientation =\n        typeof initialSettings.orientation === \"string\"\n          ? Orientation.from(initialSettings.orientation)\n          : initialSettings.orientation;\n    }\n    // Handle other settings\n    if (initialSettings.pixelDensity !== undefined) {\n      this.settings.pixelDensity = initialSettings.pixelDensity;\n    }\n    if (initialSettings.interlaced !== undefined) {\n      this.settings.interlaced = initialSettings.interlaced;\n    }\n    if (initialSettings.field !== undefined) {\n      this.settings.field = initialSettings.field;\n    }\n  }\n\n  /**\n   * Connect to a GPU context for buffer synchronization\n   */\n  connect(gpuContext: IGpuContext): void {\n    this.gpuContext = gpuContext;\n    // Sync current settings to GPU\n    this.syncToGpu();\n  }\n\n  /**\n   * Disconnect from GPU context\n   */\n  disconnect(): void {\n    this.gpuContext = null;\n  }\n\n  /**\n   * Get the current orientation\n   */\n  get orientation(): Orientation {\n    return this.settings.orientation;\n  }\n\n  /**\n   * Set the RGB stripe orientation\n   */\n  set orientation(value: Orientation) {\n    this.settings.orientation = value;\n    if (this.gpuContext?.initialized) {\n      this.gpuContext.writeOrientation(value.toBoolean());\n    }\n  }\n\n  /**\n   * Get the current pixel density\n   */\n  get pixelDensity(): number {\n    return this.settings.pixelDensity;\n  }\n\n  /**\n   * Set the pixel density for chunky pixel effect\n   */\n  set pixelDensity(value: number) {\n    const clampedValue = Math.max(1, Math.floor(value));\n    this.settings.pixelDensity = clampedValue;\n    if (this.gpuContext?.initialized) {\n      this.gpuContext.writePixelDensity(clampedValue);\n    }\n  }\n\n  /**\n   * Get the current interlaced mode\n   */\n  get interlaced(): boolean {\n    return this.settings.interlaced;\n  }\n\n  /**\n   * Set interlaced rendering mode\n   */\n  set interlaced(value: boolean) {\n    this.settings.interlaced = value;\n    if (this.gpuContext?.initialized) {\n      this.gpuContext.writeInterlaced(value);\n    }\n  }\n\n  /**\n   * Get the current field selection\n   */\n  get field(): \"odd\" | \"even\" {\n    return this.settings.field;\n  }\n\n  /**\n   * Set field selection for interlaced rendering\n   */\n  set field(value: \"odd\" | \"even\") {\n    this.settings.field = value;\n    if (this.gpuContext?.initialized) {\n      this.gpuContext.writeField(value === \"odd\");\n    }\n  }\n\n  /**\n   * Get a copy of all current settings\n   */\n  getSettings(): ProcessorSettings {\n    return { ...this.settings };\n  }\n\n  /**\n   * Update multiple settings at once\n   */\n  updateSettings(updates: Partial<ProcessorSettings>): void {\n    if (updates.orientation !== undefined) {\n      // Convert string to value object if needed (for backward compatibility)\n      // Type assertion needed because ProcessorSettings.orientation is OrientationVO,\n      // but we allow string input for backward compatibility\n      const orientationValue = updates.orientation as\n        | Orientation\n        | OrientationType;\n      const orientation =\n        typeof orientationValue === \"string\"\n          ? Orientation.from(orientationValue)\n          : orientationValue;\n      this.orientation = orientation;\n    }\n    if (updates.pixelDensity !== undefined) {\n      this.pixelDensity = updates.pixelDensity;\n    }\n    if (updates.interlaced !== undefined) {\n      this.interlaced = updates.interlaced;\n    }\n    if (updates.field !== undefined) {\n      this.field = updates.field;\n    }\n  }\n\n  /**\n   * Sync all settings to GPU buffers\n   */\n  private syncToGpu(): void {\n    if (!this.gpuContext?.initialized) {\n      return;\n    }\n    this.gpuContext.writeOrientation(this.settings.orientation.toBoolean());\n    this.gpuContext.writePixelDensity(this.settings.pixelDensity);\n    this.gpuContext.writeInterlaced(this.settings.interlaced);\n    this.gpuContext.writeField(this.settings.field === \"odd\");\n  }\n}\n"],"names":["SettingsManager","initialSettings","DEFAULT_SETTINGS","Orientation","gpuContext","value","clampedValue","updates","orientationValue","orientation"],"mappings":";;AAwBO,MAAMA,EAA4C;AAAA,EAC/C;AAAA,EACA,aAAiC;AAAA,EAEzC,YAAYC,IAAiC,IAAI;AAC/C,SAAK,WAAW,EAAE,GAAGC,EAAA,GAEjBD,EAAgB,gBAAgB,WAClC,KAAK,SAAS,cACZ,OAAOA,EAAgB,eAAgB,WACnCE,EAAY,KAAKF,EAAgB,WAAW,IAC5CA,EAAgB,cAGpBA,EAAgB,iBAAiB,WACnC,KAAK,SAAS,eAAeA,EAAgB,eAE3CA,EAAgB,eAAe,WACjC,KAAK,SAAS,aAAaA,EAAgB,aAEzCA,EAAgB,UAAU,WAC5B,KAAK,SAAS,QAAQA,EAAgB;AAAA,EAE1C;AAAA;AAAA;AAAA;AAAA,EAKA,QAAQG,GAA+B;AACrC,SAAK,aAAaA,GAElB,KAAK,UAAA;AAAA,EACP;AAAA;AAAA;AAAA;AAAA,EAKA,aAAmB;AACjB,SAAK,aAAa;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,cAA2B;AAC7B,WAAO,KAAK,SAAS;AAAA,EACvB;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,YAAYC,GAAoB;AAClC,SAAK,SAAS,cAAcA,GACxB,KAAK,YAAY,eACnB,KAAK,WAAW,iBAAiBA,EAAM,UAAA,CAAW;AAAA,EAEtD;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,eAAuB;AACzB,WAAO,KAAK,SAAS;AAAA,EACvB;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,aAAaA,GAAe;AAC9B,UAAMC,IAAe,KAAK,IAAI,GAAG,KAAK,MAAMD,CAAK,CAAC;AAClD,SAAK,SAAS,eAAeC,GACzB,KAAK,YAAY,eACnB,KAAK,WAAW,kBAAkBA,CAAY;AAAA,EAElD;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,aAAsB;AACxB,WAAO,KAAK,SAAS;AAAA,EACvB;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,WAAWD,GAAgB;AAC7B,SAAK,SAAS,aAAaA,GACvB,KAAK,YAAY,eACnB,KAAK,WAAW,gBAAgBA,CAAK;AAAA,EAEzC;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,QAAwB;AAC1B,WAAO,KAAK,SAAS;AAAA,EACvB;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,MAAMA,GAAuB;AAC/B,SAAK,SAAS,QAAQA,GAClB,KAAK,YAAY,eACnB,KAAK,WAAW,WAAWA,MAAU,KAAK;AAAA,EAE9C;AAAA;AAAA;AAAA;AAAA,EAKA,cAAiC;AAC/B,WAAO,EAAE,GAAG,KAAK,SAAA;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKA,eAAeE,GAA2C;AACxD,QAAIA,EAAQ,gBAAgB,QAAW;AAIrC,YAAMC,IAAmBD,EAAQ,aAG3BE,IACJ,OAAOD,KAAqB,WACxBL,EAAY,KAAKK,CAAgB,IACjCA;AACN,WAAK,cAAcC;AAAA,IACrB;AACA,IAAIF,EAAQ,iBAAiB,WAC3B,KAAK,eAAeA,EAAQ,eAE1BA,EAAQ,eAAe,WACzB,KAAK,aAAaA,EAAQ,aAExBA,EAAQ,UAAU,WACpB,KAAK,QAAQA,EAAQ;AAAA,EAEzB;AAAA;AAAA;AAAA;AAAA,EAKQ,YAAkB;AACxB,IAAK,KAAK,YAAY,gBAGtB,KAAK,WAAW,iBAAiB,KAAK,SAAS,YAAY,WAAW,GACtE,KAAK,WAAW,kBAAkB,KAAK,SAAS,YAAY,GAC5D,KAAK,WAAW,gBAAgB,KAAK,SAAS,UAAU,GACxD,KAAK,WAAW,WAAW,KAAK,SAAS,UAAU,KAAK;AAAA,EAC1D;AACF;"}