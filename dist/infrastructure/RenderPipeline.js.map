{"version":3,"file":"RenderPipeline.js","sources":["../../src/infrastructure/RenderPipeline.ts"],"sourcesContent":["/**\n * Render Pipeline\n * Handles WebGPU pipeline creation and rendering\n */\nimport type { TgpuRenderPipeline } from \"typegpu\";\nimport { fullScreenTriangle } from \"typegpu/common\";\n\nimport {\n  createSubpixelFragment,\n  bindGroupLayout,\n} from \"./shaders/subpixel-fragment.js\";\nimport type { IRenderPipeline } from \"../core/ports/IRenderPipeline.js\";\nimport type { IGpuContext } from \"../core/ports/IGpuContext.js\";\n\n/**\n * Manages the render pipeline for CRT subpixel effect\n */\nexport class RenderPipeline implements IRenderPipeline {\n  private pipeline: TgpuRenderPipeline | null = null;\n  private gpuContext: IGpuContext | null = null;\n\n  /**\n   * Check if pipeline is created\n   */\n  get isCreated(): boolean {\n    return this.pipeline !== null;\n  }\n\n  /**\n   * Get the bind group layout for external textures\n   */\n  get externalTextureLayout(): unknown {\n    return bindGroupLayout;\n  }\n\n  /**\n   * Create the render pipeline\n   * @param gpuContext The GPU context to use\n   */\n  create(gpuContext: IGpuContext): void {\n    this.gpuContext = gpuContext;\n\n    const fragmentFn = createSubpixelFragment(\n      gpuContext.sampler,\n      gpuContext.outputDimensionsBuffer,\n      gpuContext.inputDimensionsBuffer,\n      gpuContext.orientationBuffer,\n      gpuContext.pixelDensityBuffer,\n      gpuContext.interlacedBuffer,\n      gpuContext.fieldBuffer,\n    );\n\n    this.pipeline = gpuContext.tgpuRoot[\"~unstable\"]\n      .withVertex(fullScreenTriangle, {})\n      .withFragment(fragmentFn, { format: gpuContext.presentationFormat })\n      .createPipeline();\n\n    console.log(\"Render pipeline created successfully\");\n  }\n\n  /**\n   * Render a frame using an external texture source\n   * @param source Video element or VideoFrame to render\n   * @param textureView The target texture view\n   */\n  render(\n    source: HTMLVideoElement | VideoFrame,\n    textureView: GPUTextureView,\n  ): void {\n    if (!this.pipeline || !this.gpuContext) {\n      throw new Error(\"Pipeline not created\");\n    }\n\n    // Create bind group with external texture\n    // Type assertion needed for bindGroupLayout compatibility\n    const externalTexture = this.gpuContext.createBindGroup(\n      bindGroupLayout as Parameters<typeof this.gpuContext.createBindGroup>[0],\n      {\n        externalTexture: this.gpuContext.device.importExternalTexture({\n          source,\n        }),\n      },\n    );\n\n    // Render to target\n    this.pipeline\n      .with(externalTexture)\n      .withColorAttachment({\n        view: textureView,\n        loadOp: \"clear\",\n        clearValue: { r: 0, g: 0, b: 0, a: 1 },\n        storeOp: \"store\",\n      })\n      .draw(3);\n  }\n\n  /**\n   * Clean up pipeline resources\n   */\n  destroy(): void {\n    this.pipeline = null;\n    this.gpuContext = null;\n  }\n}\n"],"names":["RenderPipeline","bindGroupLayout","gpuContext","fragmentFn","createSubpixelFragment","fullScreenTriangle","source","textureView","externalTexture"],"mappings":";;AAiBO,MAAMA,EAA0C;AAAA,EAC7C,WAAsC;AAAA,EACtC,aAAiC;AAAA;AAAA;AAAA;AAAA,EAKzC,IAAI,YAAqB;AACvB,WAAO,KAAK,aAAa;AAAA,EAC3B;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,wBAAiC;AACnC,WAAOC;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,OAAOC,GAA+B;AACpC,SAAK,aAAaA;AAElB,UAAMC,IAAaC;AAAA,MACjBF,EAAW;AAAA,MACXA,EAAW;AAAA,MACXA,EAAW;AAAA,MACXA,EAAW;AAAA,MACXA,EAAW;AAAA,MACXA,EAAW;AAAA,MACXA,EAAW;AAAA,IAAA;AAGb,SAAK,WAAWA,EAAW,SAAS,WAAW,EAC5C,WAAWG,GAAoB,CAAA,CAAE,EACjC,aAAaF,GAAY,EAAE,QAAQD,EAAW,mBAAA,CAAoB,EAClE,eAAA,GAEH,QAAQ,IAAI,sCAAsC;AAAA,EACpD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,OACEI,GACAC,GACM;AACN,QAAI,CAAC,KAAK,YAAY,CAAC,KAAK;AAC1B,YAAM,IAAI,MAAM,sBAAsB;AAKxC,UAAMC,IAAkB,KAAK,WAAW;AAAA,MACtCP;AAAA,MACA;AAAA,QACE,iBAAiB,KAAK,WAAW,OAAO,sBAAsB;AAAA,UAC5D,QAAAK;AAAA,QAAA,CACD;AAAA,MAAA;AAAA,IACH;AAIF,SAAK,SACF,KAAKE,CAAe,EACpB,oBAAoB;AAAA,MACnB,MAAMD;AAAA,MACN,QAAQ;AAAA,MACR,YAAY,EAAE,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,EAAA;AAAA,MACnC,SAAS;AAAA,IAAA,CACV,EACA,KAAK,CAAC;AAAA,EACX;AAAA;AAAA;AAAA;AAAA,EAKA,UAAgB;AACd,SAAK,WAAW,MAChB,KAAK,aAAa;AAAA,EACpB;AACF;"}